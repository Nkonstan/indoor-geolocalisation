<!DOCTYPE html>
<html>
<head>
    <title>Image Analysis Results</title> <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background-color: white; /* Set body background to white */
            color: black; /* Ensure text is visible */
            padding: 20px; /* Added some padding */
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-top: 20px; /* Reduced top margin */
            max-width: 1600px; /* Added max-width for very large screens */
            margin-left: auto;
            margin-right: auto;
        }
        h1 {
            color: #333;
            margin-bottom: 5px;
        }
        h2 {
            color: #4CAF50;
            margin-bottom: 5px; /* Reduced margin below h2 */
        }
        /* Style for descriptive paragraphs under headings */
        .section-description {
            font-size: 0.9em;
            color: #555;
            margin-top: 0;
            margin-bottom: 15px;
            max-width: 600px; /* Limit width for readability */
            margin-left: auto;
            margin-right: auto;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            margin: 4px 0; /* Slightly reduced margin */
            font-size: 0.9em; /* Slightly smaller font for list items */
        }
        button, .button-link { /* Style links like buttons */
            margin-top: 20px; /* Reduced margin */
            margin-left: 10px;
            margin-right: 10px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none; /* Remove underline from link styled as button */
            color: white; /* Text color for link styled as button */
            background-color: #4CAF50; /* Match button color */
            border: none;
            border-radius: 4px;
            display: inline-block; /* Allow margins */
        }
        .button-link:hover {
            background-color: #45a049;
        }
        button:hover {
            background-color: #45a049;
        }

        .chart-container {
            position: relative;
            height: 35vh;
            width: 35vw;
            min-width: 250px; /* Ensure minimum size */
            min-height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            flex-direction: column; /* Stack chart and explanation */
        }
        .chart-center {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60%; /* Adjusted width */
            height: 60%; /* Adjusted height */
            top: 20%;  /* Adjusted positioning */
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .chart-center h4 {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #333;
        }
        .score-explanation {
             font-size: 0.8em;
             color: #666;
             margin-top: 10px;
        }

        .material-recognition {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center;
            align-items: center; /* Vertically center items */
            width: 100%;
            margin-top: 20px;
            gap: 30px; /* Add gap between image and table */
        }
        .material-recognition img {
            /* Removed margin-right, using gap now */
            align-self: center; /* Center image vertically */
            max-width: 384px; /* Ensure image fits */
        }
        .material-table {
            width: auto; /* Adjust width automatically */
            min-width: 250px; /* Minimum width */
            border-collapse: collapse;
            margin: 0; /* Remove margin */
            align-self: center; /* Center table vertically */
        }
        .material-table th, .material-table td {
            border: 1px solid #ddd;
            padding: 6px; /* Adjusted padding */
            text-align: left;
            font-size: 0.9em; /* Slightly smaller font */
        }
        .material-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .material-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .material-table tr:hover {
            background-color: #f1f1f1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000; /* Ensure modal is on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Darker background */
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px; /* Max width for modal image */
        }
        .modal-content h3 { /* Added title style for modal */
            text-align: center;
            margin-top: 0;
            color: #333;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .resized-image {
            width: 384px;
            height: 384px;
            object-fit: contain; /* Ensure aspect ratio is maintained */
             border: 1px solid #eee; /* Subtle border for images */
        }
        .image-row {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center;
            align-items: flex-start; /* Align items at the start */
            margin-top: 20px;
            width: 100%;
            gap: 20px; /* Add gap between items */
        }
        .image-container, .chart-container-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Removed fixed margin, using gap in image-row now */
        }
        .image-title {
            min-height: 40px; /* Use min-height instead of fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px; /* Reduced space */
            text-align: center;
        }
        .popup-link {
            color: #007BFF;
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold; /* Make link more prominent */
        }
        .popup-link:hover {
            color: #0056b3;
        }
        .button-container { /* Container for buttons at the bottom */
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee; /* Separator line */
            width: 100%;
            text-align: center;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <h1>Image Geo-location & Material Analysis</h1>
        <p class="section-description" style="font-style: italic;">
            This analysis uses advanced AI models to interpret the image content for location and materials.
        </p>

        <div class="image-row">
            <div class="image-container">
                <h2 class="image-title">Your Uploaded Image</h2>
                <img id="inputImage" src="{{ image_path }}" alt="Uploaded Image" class="resized-image" onclick="getImageClickCoordinates(event)">
            </div>
            <div class="image-container">
                <h2 class="image-title">Heatmap</h2>
                 <p class="section-description">Highlighted regions show where our geo-location model focused its attention to make the prediction.</p>
                <img src="{{ attention_map_path }}" alt="Attention Map" class="resized-image">
            </div>
            <div class="chart-container-wrapper">
                <h2 class="image-title">Location Predictions</h2>
                <p class="section-description">Location estimates provided by our geo-location model.</p>
                <div class="chart-wrapper">
                    <div class="chart-container">
                        <canvas id="continentChart"></canvas>
                    </div>
                    <div class="chart-center">
                        <h4>Top Country Guesses:</h4>
                        <ul>
                            {% for country, score in prediction_message.items() %}
                                <li><strong>{{ country }}</strong>: {{ score }}%</li>
                            {% endfor %}
                        </ul>
                    </div>
                     <p class="score-explanation">Scores represent the model's confidence level.</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; width: 100%;">
             <h2>Material Recognition</h2>
             <p class="section-description">Material identification performed by a separate analysis model. The mask visually highlights detected materials, detailed in the table below.</p>
             <div class="material-recognition">
                <div class="image-container"> <img src="{{ material_data.mask_image_path }}" alt="Material Mask" class="resized-image">
                     <small style="margin-top: 5px; color: #555;">Visual mask of detected materials</small>
                 </div>
                <table class="material-table">
                    <thead>
                        <tr>
                            <th>Detected Materials</th>
                            <th>Proportion</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in material_data.image_materials.split('% ') %}
                        {% if item %}
                        {% set parts = item.split(' ') %}
                        {% set material = parts[0] %}
                        {% set proportion = parts[1].replace('%', '') %}
                        <tr>
                            <td>{{ material }}</td>
                            <td>{{ proportion }}%</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <h2 class="popup-link" id="openModal">View World Indoor Material Stats</h2>
         </div>

        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>Global Distribution of Indoor Materials</h3>
                <img src="/static/material_per_country.png" alt="Material per Country" style="width:100%; display: block; margin-top: 15px;">
            </div>
        </div>

        <div class="button-container">
<!--            <a href="{{ url_for('upload_form') }}" class="button-link">New Analysis</a>-->
            <a href="/" class="button-link">New Analysis</a>
            <button id="furtherAnalysisButton" onclick="goToFurtherAnalysis()">Segment Analysis</button>
        </div>

    </div>

    <script>
        // Chart.js Script (no changes needed based on request)
        var continentData = {{ continent_percentages | tojson | safe }};
        var ctx = document.getElementById('continentChart').getContext('2d');
        var continentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(continentData),
                datasets: [{
                    label: 'Continent Confidence', // Added dataset label
                    data: Object.values(continentData),
                    backgroundColor: [ // Slightly more distinct colors
                        'rgba(54, 162, 235, 0.5)', // Blue
                        'rgba(255, 206, 86, 0.5)', // Yellow
                        'rgba(75, 192, 192, 0.5)', // Teal
                        'rgba(153, 102, 255, 0.5)', // Purple
                        'rgba(255, 159, 64, 0.5)', // Orange
                        'rgba(255, 99, 132, 0.5)' // Red
                    ],
                    borderColor: [
                         'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                 responsive: true, // Ensure chart responsiveness
                 maintainAspectRatio: false, // Allow flexible sizing
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Continent Prediction Confidence', // Updated chart title
                        font: {
                            size: 16, // Adjusted size
                            weight: 'bold'
                        }
                    },
                    tooltip: { // Customize tooltips if needed
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                cutout: '50%',
                animation: {
                    duration: 1000,
                    easing: 'easeInOutBounce'
                }
                // Removed scales option for y-axis as it's not applicable to doughnut charts
            }
        });
    </script>

    <script>
        function getImageClickCoordinates(event) {
            // This function remains as provided, but its effects (updating a non-existent
            // #segmentedImage and showing an already visible button) might not work as intended.
            var image = document.getElementById('inputImage');
            var rect = image.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;

            fetch('/process_click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ x: x, y: y, image_path: "{{ image_path }}" })
            })
            .then(response => response.json())
            .then(data => {
                if (data.segmented_image) {
                    // Attempt to update non-existent element:
                     try {
                        var segmentedImg = document.getElementById('segmentedImage');
                         if(segmentedImg) { // Check if element exists before using it
                            segmentedImg.src = 'data:image/png;base64,' + data.segmented_image;
                         } else {
                             console.warn("Element with ID 'segmentedImage' not found.");
                         }
                     } catch (e) { console.error("Error updating segmented image:", e); }


                    // Attempt to display already visible button:
                     try {
                         var furtherButton = document.getElementById('furtherAnalysisButton');
                         if(furtherButton) { // Check if element exists
                            furtherButton.style.display = 'inline-block'; // Ensure it's visible (might be block or inline-block depending on styling)
                         } else {
                             console.warn("Element with ID 'furtherAnalysisButton' not found.");
                         }
                     } catch (e) { console.error("Error showing further analysis button:", e); }
                }
            })
             .catch(error => { // Added error handling for fetch
                console.error('Error processing click:', error);
            });
        }

         // Ensure the correct version of goToFurtherAnalysis is used (passing image_path)
        function goToFurtherAnalysis() {
            // Check if image_path is available and not empty
            const imagePath = "{{ image_path | e }}"; // Use 'e' filter for proper URL encoding in Flask/Jinja
            if (imagePath) {
                 window.location.href = '/further-analysis?image_path=' + encodeURIComponent(imagePath);
            } else {
                console.error("Image path is not available for further analysis.");
                alert("Cannot proceed to segment analysis: image path is missing.");
            }
        }
    </script>

    <script>
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("openModal");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function() {
            modal.style.display = "block";
        }

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>

</body>
</html>
