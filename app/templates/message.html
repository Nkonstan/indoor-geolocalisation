
<!DOCTYPE html>
<html>
<head>
<title>Image Analysis Results</title>
<style>
    /* --- Previous Styles --- */
    body {
        text-align: center;
        font-family: Arial, sans-serif;
        background-color: white;
        color: black;
        padding: 20px;
    }

    .container {
        margin-top: 20px;
        max-width: 2100px;
        margin-left: auto;
        margin-right: auto;
    }

    h1.main-title {
        color: #333;
        margin-bottom: 5px;
    }
    p.intro-note {
        font-size: 0.9em; color: #555; margin-top: 0; margin-bottom: 25px;
        max-width: 800px; margin-left: auto; margin-right: auto; font-style: italic;
    }

    .main-content-wrapper {
        display: flex; flex-wrap: wrap; justify-content: space-between;
        width: 100%; gap: 20px;
    }

    .left-content {
        flex: 2; min-width: 600px;
        display: flex; /* Using Flexbox */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center children (image-row, material-section) horizontally */
    }

    h2 { color: #4CAF50; margin-bottom: 5px; font-size: 1.3em; }
    .section-description {
        font-size: 0.85em; color: #555; margin-top: 0; margin-bottom: 10px;
        max-width: 600px; margin-left: auto; margin-right: auto; text-align: center;
    }

    ul { list-style-type: none; padding: 0; }
    li { margin: 3px 0; font-size: 0.85em; }

    button, .button-link {
        margin-top: 10px; margin-left: 5px; margin-right: 5px; padding: 8px 16px;
        font-size: 0.95em; cursor: pointer; background-color: #4CAF50; color: white;
        border: none; border-radius: 4px; text-decoration: none; display: inline-block;
    }
    .button-link:hover, button:hover { background-color: #45a049; }

    :root {
        --element-size: 300px;
        --chart-height: calc(var(--element-size) * 0.85);
    }

    .chart-container-wrapper {
        display: flex; flex-direction: column; align-items: center;
        width: var(--element-size);
    }
    .chart-container {
        position: relative; height: var(--chart-height); width: 100%;
        display: flex; justify-content: center; align-items: center; margin-top: 5px;
    }
    .chart-wrapper {
        display: flex; flex-direction: column; justify-content: center;
        align-items: center; position: relative; width: 100%;
    }
    .chart-center {
        position: absolute; display: flex; flex-direction: column; align-items: center;
        justify-content: center; width: 60%; height: 60%; top: 20%; left: 50%;
        transform: translateX(-50%); text-align: center;
    }
     .chart-center h4 { margin-bottom: 5px; font-size: 0.9em; color: #333; }
    .score-explanation { font-size: 0.8em; color: #666; margin-top: 8px; }

    .image-row { /* Container for top row items */
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* Center the items (image/chart containers) horizontally */
        align-items: flex-start;
        width: 100%; /* Takes full width available in .left-content */
        gap: 10px;
        margin-bottom: 20px; /* Space below this row */
    }

    .image-container { /* Container for Input Image AND Heatmap Image */
        display: flex;
        flex-direction: column;
        align-items: center; /* Center title/desc/image within */
        width: var(--element-size);
    }

    .image-title {
        min-height: 35px; font-size: 1.1em; display: flex; align-items: center;
        justify-content: center; margin-bottom: 5px; text-align: center;
    }

    .resized-image { /* Applies to Input, Heatmap, Material Mask */
        width: var(--element-size); height: var(--element-size);
        object-fit: contain; border: 1px solid #eee;
    }

    .material-section { /* Section containing material info */
         width: 100%; /* Takes full width available in .left-content */
         margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;
    }
     .material-title { font-size: 1.2em; margin-bottom: 5px; }

    .material-recognition { /* Container for mask image + table */
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* Center the items (image container + table) horizontally */
        align-items: center;
        width: 100%;
        margin-top: 10px;
        gap: 15px;
    }

     .material-image-container { /* Container specifically for mask image + caption */
        display: flex;
        flex-direction: column;
        align-items: center; /* Center image and caption within */
        width: var(--element-size);
        margin-left: 300px;
        /* margin-left: 30px; */ /* REMOVED explicit margin */
    }
    .material-image-container small { /* Caption below mask image */
        margin-top: 5px; font-size: 0.8em; color: #555;
        display: block; /* Ensure it takes its own line */
        width: 100%; /* Take width of container */
        text-align: center; /* Center the text */
    }

    .material-table {
        width: auto; max-width: var(--element-size); min-width: 200px;
        border-collapse: collapse; align-self: center; margin-top: 10px;
    }
    .material-table th, .material-table td { border: 1px solid #ddd; padding: 5px; text-align: left; font-size: 0.85em; }
    .material-table th { background-color: #f2f2f2; font-weight: bold; }
    .material-table tr:nth-child(even) { background-color: #f9f9f9; }
    .material-table tr:hover { background-color: #f1f1f1; }

    /* --- Styles for Chat, Modal, Stats, Architectural Elements, Responsive --- */
    /* --- (Keep all these styles as they were in the previous version) --- */
    /* Chat Styles */
    .chat-sidebar { flex: 1; min-width: 400px; max-width: 800px; position: sticky; top: 20px; height: calc(100vh - 40px); display: flex; flex-direction: column; }
    .chat-sidebar h2 { margin-bottom: 10px; text-align: center; }
    #chatWindow { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background: white; padding: 10px; text-align: left; }
    #chatWindow p { margin: 8px 0; padding: 8px; border-radius: 4px; word-wrap: break-word; }
    #chatWindow p.system { background: #f0f0f0; color: #666; font-style: italic; }
    #chatWindow p.assistant { background: #e8f5e9; }
    #chatWindow p.user { background: #e3f2fd; }
    .chat-input-container { display: flex; gap: 10px; margin-top: 10px; }
    #chatInput { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .chat-input-container button { margin-top: 0; }
    .confidence-indicator { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px; }
    .confidence-high { background-color: #4CAF50; color: white; }
    .confidence-medium { background-color: #FFA726; color: white; }
    .confidence-low { background-color: #EF5350; color: white; }
    .uncertainty-notes { font-size: 0.85em; color: #666; margin-top: 8px; padding-left: 10px; border-left: 3px solid #ddd; }
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .modal-content h2 { text-align: center; margin-top: 0; color: #333; margin-bottom: 15px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    /* Stats Container/Button Styling */
    .stats-container { width: 100%; margin: 20px 0; padding: 15px; border-radius: 8px; background: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
    .stats-button { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; margin-top: 0; }
    .stats-button:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .stats-info { font-size: 0.85em; color: #666; margin-top: 8px; }
    .stats-icon { width: 18px; height: 18px; }
    .stats-description { color: #666; line-height: 1.6; margin: 15px 0; text-align: center; font-size: 0.95em; }
    /* Architectural Elements */
    .architectural-elements { margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; width: 100%; border-top: 1px solid #eee; }
    .architectural-elements h2 { text-align: center; color: #4CAF50; margin-bottom: 15px; font-size: 1.2em; }
    .architectural-elements .section-description { margin-bottom: 30px; font-size: 0.85em; }
    .elements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 0 10px; }
    .element-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
    .element-card h3 { text-align: center; padding: 10px; margin: 0; background-color: #f0f0f0; font-size: 1em; color: #333; }
    .element-content { padding: 15px; flex-grow: 1; }
    .element-image { width: 100%; height: 180px; overflow: hidden; border-radius: 4px; margin-bottom: 15px; }
    .element-image img { width: 100%; height: 100%; object-fit: cover; }
    .similar-segments h4 { color: #4CAF50; margin: 15px 0 10px 0; font-size: 0.95em; }
    .similar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
    .similar-item { border-radius: 4px; overflow: hidden; background: #f5f5f5; border: 1px solid #eee; }
    .segment-image { height: 90px; overflow: hidden; display: block; }
    .segment-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s; display: block; }
    .segment-image img:hover { transform: scale(1.1); }
    .segment-info { padding: 6px; background: white; font-size: 0.75em; }
    .segment-info span { display: block; line-height: 1.3; }
    .similarity-score { color: #4CAF50; font-weight: bold; }
    .country { color: #666; }
    /* Navigation Button Styling */
    .button-group { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; width: 100%; text-align: center; }
    /* Responsive Adjustments */
    @media (max-width: 992px) {
        .main-content-wrapper { flex-direction: column; align-items: center; }
        .left-content { min-width: unset; width: 100%; order: 1; }
        .chat-sidebar { position: relative; top: unset; width: 100%; max-width: 800px; height: 60vh; order: 2; margin-top: 30px; }
    }
     @media (max-width: 768px) {
         :root { /* --element-size: 280px; */ }
         .image-row { flex-direction: column; align-items: center; gap: 20px; }
         .chart-container-wrapper { margin-top: 20px; width: 90%; }
          .image-container { width: 90%; }
         .resized-image { width: 100%; height: auto; }
         .material-recognition { flex-direction: column; gap: 20px; }
          .material-image-container { width: 90%; }
         .material-table { width: 80%; max-width: none; }
         .elements-grid { grid-template-columns: 1fr; }
         .similar-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
     }
      @media (max-width: 480px) {
         :root { --element-size: 260px; --chart-height: calc(var(--element-size) * 0.85); }
         h1.main-title { font-size: 1.5em; }
         h2 { font-size: 1.1em; }
         .elements-grid { grid-template-columns: 1fr; gap: 15px; }
         .element-image { height: 160px; }
         .similar-grid { grid-template-columns: repeat(2, 1fr); }
     }

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">

        <h1 class="main-title">Image-Based Indoors Geolocalisation</h1>
        <p class="intro-note">
            This analysis uses advanced AI models to interpret the image content for location, materials, and architectural elements.
        </p>

        {% if error %}
            <div class="alert alert-danger" role="alert">
              Error processing image: {{ error }}
            </div>
             <div class="button-group">
                 <a href="{{ url_for('main.upload_form') }}" class="button-link">Try Another Analysis</a>
             </div>
        {% else %}
            <div class="main-content-wrapper">

                <div class="left-content">

                    <div class="image-row">
                        <div class="image-container"> <!-- Holds Input Image -->
                            <h2 class="image-title">Investigation Image</h2>
                            <img id="inputImage" src="{{ url_for('static', filename=image_path.replace('static/', '')) }}"
                                 alt="Uploaded Image" class="resized-image">
                            <!-- No description needed here -->
                        </div>
                        <div class="image-container"> <!-- Holds Heatmap -->
                             <h2 class="image-title">Geolocation Model Heatmap</h2>
                             <!-- Heatmap Description -->
                            <p class="section-description" style="margin-bottom: 5px; width: 100%;">The highlighted areas influence the model's prediction the most.</p>
                            <img src="{{ url_for('static', filename=attention_map_path.replace('static/', '')) }}"
                                 alt="Attention Map" class="resized-image">
                        </div>
                        <div class="chart-container-wrapper"> <!-- Holds Location Chart -->
                             <h2 class="image-title">Geolocation Model Predictions</h2>
                            <p class="section-description" style="margin-bottom: 5px;">Location estimates from our geo-location model.</p>
                            <div class="chart-wrapper">
                                <div class="chart-container">
                                    <canvas id="continentChart"></canvas>
                                </div>
                                <div class="chart-center">
                                    <h4>Top Country Guesses:</h4>
                                    <ul>
                                        {% for country, score in prediction_message.items() %}
                                            <li><strong>{{ country }}</strong>: {{ score }}%</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <p class="score-explanation">Scores represent the model's confidence level.</p>
                            </div>
                        </div>
                    </div> <!-- End image-row -->

                    {% if material_data %}
                    <div class="material-section"> <!-- Contains Material Recognition -->
                         <h2 class="material-title">Material Recognition Model</h2>
                        <p class="section-description">Materials recognition model with geographical similarity analysis</p>

                        <div class="material-recognition"> <!-- Flex container for image+table -->
                            <div class="material-image-container"> <!-- Holds Material Mask Image -->
                                <img src="{{ url_for('static', filename=material_data.mask_image_path.replace('/static/', '')) }}"
                                     alt="Material Mask" class="resized-image">
                                <!-- Material Mask Description -->
                                <small style="width: 100%; text-align: center;">Visual mask highlighting detected materials</small>
                             </div>
                            <table class="material-table">
                                <thead>
                                    <tr>
                                        <th>Detected Materials</th>
                                        <th>Proportion</th>
                                        <th>Closest Country</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in material_data.image_materials.split('% ') %}
                                    {% if item %}
                                    {% set parts = item.split(' ') %}
                                    {% set material = parts[0] %}
                                    {% set proportion = parts[1].replace('%', '') %}
                                    <tr>
                                        <td>{{ material }}</td>
                                        <td>{{ proportion }}%</td>
                                        <td>{% if material_data.closest_countries and material_data.closest_countries.get(material) %}{{ material_data.closest_countries.get(material) }}{% else %}-{% endif %}</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
<!--                            <table class="material-table">-->
<!--                                <thead>-->
<!--                                    <tr>-->
<!--                                        <th>Detected Materials</th>-->
<!--                                        <th>Proportion</th>-->
<!--                                    </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                    {% for item in material_data.image_materials.split('% ') %}-->
<!--                                    {% if item %}-->
<!--                                    {% set parts = item.split(' ') %}-->
<!--                                    {% set material = parts[0] %}-->
<!--                                    {% set proportion = parts[1].replace('%', '') %}-->
<!--                                    <tr>-->
<!--                                        <td>{{ material }}</td>-->
<!--                                        <td>{{ proportion }}%</td>-->
<!--                                    </tr>-->
<!--                                    {% endif %}-->
<!--                                    {% endfor %}-->
<!--                                </tbody>-->
<!--                            </table>-->
                        </div>

                        <div class="stats-container">
                             <button class="stats-button" id="openModal">
                                <svg class="stats-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 3v18h18"></path>
                                    <path d="M18.4 7.5l-7.8 9L6 12"></path>
                                </svg>
                                View Global Material Stats
                            </button>
                            <p class="stats-info">
                                Click to explore the distribution of interior materials across different countries.
                            </p>
                        </div>
                    </div>
                    {% endif %}

                     {% if segmentation_results %}
                     <div class="architectural-elements"> <!-- Contains Architectural Elements -->
                          <h2>Architectural Elements Analysis</h2>
                         <p class="section-description">Identifies distinct architectural styles and finds visually similar examples from different countries.</p>
                         <div class="elements-grid">
                             {% for element_type, data in segmentation_results.items() %}
                             <div class="element-card">
                                 <h3>{{ element_type | title }}</h3>
                                 <div class="element-content">
                                     <div class="element-image">
                                         <img src="{{ url_for('static', filename=data.cropped_image_path.replace('static/', '')) }}"
                                              alt="{{ element_type }}" class="segmented-image">
                                     </div>
                                     {% if data.get('similar_segments_info') %}
                                     <div class="similar-segments">
                                         <h4>Similar Segments Found</h4>
                                         <div class="similar-grid">
                                             {% for segment in data.similar_segments_info %}
                                             <div class="similar-item">
                                                 <div class="segment-image">
                                                     <img src="{{ url_for('main.serve_segmentations', filename=segment.path) }}"
                                                          alt="Similar {{ element_type }}">
                                                 </div>
                                                 <div class="segment-info">
                                                     <span class="similarity-score">Score: {{ "%.2f"|format(segment.score|float) }}</span>
                                                     <span class="country">{{ segment.country }}</span>
                                                 </div>
                                             </div>
                                             {% endfor %}
                                         </div>
                                     </div>
                                     {% else %}
                                      <p style="text-align: center; color: #888; font-size: 0.9em;">No similar segments found.</p>
                                     {% endif %}
                                 </div>
                             </div>
                             {% endfor %}
                         </div>
                     </div>
                     {% endif %}

                </div> <!-- End left-content -->

                <div class="chat-sidebar"> <!-- Contains Chat -->
                     <h2>Geo-location Assistant</h2>
                    <p class="section-description">The system reviews all model outputs and delivers a final, interpretable prediction. Confidence levels (Low/Medium/High) indicate the reliability of the analysis based on visual evidence strength, regional distinctiveness, and prediction consistency.</p>
                    <div id="chatWindow">
                        {% if initial_chat %}
                            {% for message in initial_chat %}
                                {% if message.role == "system" %}
                                {% else %}
                                <div class="assistant-message">
                                    <p class="assistant">
                                        <strong>Geo-location Assistant:</strong> {% set confidence = message.content.confidence_level | default('Medium') %}
                                        <span class="confidence-indicator confidence-{{ confidence|lower }}">
                                            {% if confidence == "High" %}游릭
                                            {% elif confidence == "Medium" %}游리
                                            {% else %}游댮{% endif %}
                                            {{ confidence }} Confidence
                                        </span>
                                        <br>{{ message.content.response | default('No response content.') }}
                                        <br><br><strong>Final Location Prediction:</strong>
                                        {% if message.content.predicted_country %}
                                            {{ message.content.predicted_country }}
                                        {% else %}
                                            Not found in analysis
                                        {% endif %}
                                        {% if message.content.uncertainty %}
                                            <div class="uncertainty-notes">Note: {{ message.content.uncertainty }}</div>
                                        {% endif %}
                                    </p>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Ask about the analysis...">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div> <!-- End chat-sidebar -->

            </div> <!-- End main-content-wrapper -->

            <div id="myModal" class="modal"> <!-- Modal -->
                <div class="modal-content">
                    <span class="close">&times;</span>
                     <h2>Global Interior Material Distribution</h2>
                    <p class="stats-description">
                        This visualization shows how different interior materials are distributed across countries,
                        helping understand regional preferences and design patterns.
                    </p>
                    <img src="/static/material_per_country.png" alt="Material per Country" style="width:100%; display: block; margin-top: 15px;">
                </div>
            </div>


            <div class="button-group"> <!-- Navigation Buttons -->
                 <a href="{{ url_for('main.upload_form') }}" class="button-link">New Analysis</a>
            </div>

        {% endif %} <!-- End main success block -->
    </div> <!-- End container -->

    <!-- JAVASCRIPT -->
    <script>
        // Chart.js Script (Modified title, added label)
        var continentData = {{ continent_percentages | default({}) | tojson | safe }}; // Added default
        var ctx = document.getElementById('continentChart').getContext('2d');
        var continentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(continentData),
                datasets: [{
                    label: 'Continent Confidence', // Added label
                    data: Object.values(continentData),
                    backgroundColor: [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(255, 99, 132, 0.6)' ],
                    borderColor: [ 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 99, 132, 1)' ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Keep false to allow height adjustment
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: { display: true, text: 'Continent Prediction Confidence', font: { size: 14, weight: 'bold' } },
                     tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += context.parsed.toFixed(1) + '%'; } return label; } } }
                },
                cutout: '50%',
                animation: { duration: 1000, easing: 'easeInOutBounce' }
            }
        });
    </script>
    <script>
        // Modal script
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("openModal");
        var span = document.getElementsByClassName("close")[0];
        if (btn) { btn.onclick = function() { if(modal) modal.style.display = "block"; } }
        if (span) { span.onclick = function() { if(modal) modal.style.display = "none"; } }
        window.onclick = function(event) { if (event.target == modal) { if(modal) modal.style.display = "none"; } }
    </script>
    <script>
        // Chat Script
        function initializeChat() {
            var chatWindow = document.getElementById('chatWindow');
            if (chatWindow) { chatWindow.scrollTop = chatWindow.scrollHeight; }
        }
        function sendMessage() {
            var chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            var message = chatInput.value;
            if (!message.trim()) return;
            chatInput.value = '';
            displayMessage("You", message);
            try {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: message, image_path: "{{ image_path | default('') | e }}" })
                })
                .then(response => { if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); })
                .then(data => { console.log("Received data:", data); if (data.reply) { displayMessage("LLaVA", data.reply); } else { console.warn("Received empty reply data."); displayMessage("System", "Received an empty response from the assistant."); } })
                .catch(error => { console.error('Error fetching or parsing response:', error); displayMessage("System", `Sorry, failed to get response: ${error.message}`); });
            } catch (error) { console.error('Error initiating fetch:', error); displayMessage("System", `Sorry, there was an error sending your message: ${error.message}`); }
        }
        function displayMessage(role, content) {
            var chatWindow = document.getElementById('chatWindow');
            if (!chatWindow) return; // Safety check

            var messageElem = document.createElement('div');
            messageElem.classList.add(role.toLowerCase() + '-message');

            let htmlContent = '';
            if (role === "LLaVA") {
                 // Check if content is the structured object or just a string
                let responseText = (typeof content === 'object' && content.response) ? content.response : (typeof content === 'string' ? content : "Received invalid assistant message format.");
                let confidence = (typeof content === 'object' && content.confidence_level) ? content.confidence_level : "Medium"; // Default confidence
                let notes = (typeof content === 'object' && content.uncertainty) ? content.uncertainty : "";
                // Extract predicted country (still defaults to "" if missing)
                let predicted_country = (typeof content === 'object' && content.predicted_country) ? content.predicted_country : "";

                let confidenceEmoji = confidence.toLowerCase() === "high" ? "游릭" :
                                    confidence.toLowerCase() === "medium" ? "游리" : "游댮";

                // Build HTML with proper comments and always show Final Location Prediction
                htmlContent = `
                    <p class="assistant">
                        <strong>Geo-location Assistant:</strong> <span class="confidence-indicator confidence-${confidence.toLowerCase()}">${confidenceEmoji} ${confidence} Confidence</span>
                        <br>${responseText}
                        <br><br><strong>Final Location Prediction:</strong> ${predicted_country ? predicted_country : 'Not found in analysis'}
                        ${notes ? `<div class="uncertainty-notes">Note: ${notes}</div>` : ''}
                    </p>`;
            } else if (role === "System") {
                htmlContent = `<p class="system"><strong>${role}:</strong> ${content}</p>`;
            } else { // User
                htmlContent = `<p class="user"><strong>${role}:</strong> ${content}</p>`;
            }

            messageElem.innerHTML = htmlContent;
            chatWindow.appendChild(messageElem);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }
        var chatInputElem = document.getElementById('chatInput');
        if (chatInputElem) { chatInputElem.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); sendMessage(); } }); }
        document.addEventListener('DOMContentLoaded', function() { {% if not error %} initializeChat(); {% endif %} });
    </script>
</body>
</html>

