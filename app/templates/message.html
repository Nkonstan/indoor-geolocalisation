
<!DOCTYPE html>
<html>
<head>
<title>Image Analysis Results</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">

        <h1 class="main-title">Image-Based Indoors Geolocalisation</h1>
        <p class="intro-note">
            This analysis uses advanced AI models to interpret the image content for location, materials, and architectural elements.
        </p>

        {% if error %}
            <div class="alert alert-danger" role="alert">
              Error processing image: {{ error }}
            </div>
             <div class="button-group">
                 <a href="{{ url_for('main.upload_form') }}" class="button-link">Try Another Analysis</a>
             </div>
        {% else %}
            <div class="main-content-wrapper">

                <div class="left-content">

                    <div class="image-row">
                        <div class="image-container"> <!-- Holds Input Image -->
                            <h2 class="image-title">Investigation Image</h2>
                            <img id="inputImage" src="{{ url_for('static', filename=image_path.replace('static/', '')) }}"
                                 alt="Uploaded Image" class="resized-image">
                            <!-- No description needed here -->
                        </div>
                        <div class="image-container"> <!-- Holds Heatmap -->
                             <h2 class="image-title">Geolocation Model Heatmap</h2>
                             <!-- Heatmap Description -->
                            <p class="section-description" style="margin-bottom: 5px; width: 100%;">The highlighted areas influence the model's prediction the most.</p>
                            <img src="{{ url_for('static', filename=attention_map_path.replace('static/', '')) }}"
                                 alt="Attention Map" class="resized-image">
                        </div>
                        <div class="chart-container-wrapper"> <!-- Holds Location Chart -->
                             <h2 class="image-title">Geolocation Model Predictions</h2>
                            <p class="section-description" style="margin-bottom: 5px;">Location estimates from our geo-location model.</p>
                            <div class="chart-wrapper">
                                <div class="chart-container">
                                    <canvas id="continentChart"></canvas>
                                </div>
                                <div class="chart-center">
                                    <h4>Top Country Guesses:</h4>
                                    <ul>
                                        {% for country, score in prediction_message.items() %}
                                            <li><strong>{{ country }}</strong>: {{ score }}%</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <p class="score-explanation">Scores represent the model's confidence level.</p>
                            </div>
                        </div>
                    </div> <!-- End image-row -->

                    {% if material_data %}
                    <div class="material-section"> <!-- Contains Material Recognition -->
                         <h2 class="material-title">Material Recognition Model</h2>
                        <p class="section-description">Materials recognition model with geographical similarity analysis</p>

                        <div class="material-recognition"> <!-- Flex container for image+table -->
                            <div class="material-image-container"> <!-- Holds Material Mask Image -->
                                <img src="{{ url_for('static', filename=material_data.mask_image_path.replace('/static/', '')) }}"
                                     alt="Material Mask" class="resized-image">
                                <!-- Material Mask Description -->
                                <small style="width: 100%; text-align: center;">Visual mask highlighting detected materials</small>
                             </div>
                            <table class="material-table">
                                <thead>
                                    <tr>
                                        <th>Detected Materials</th>
                                        <th>Proportion</th>
                                        <th>Closest Country</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in material_data.image_materials.split('% ') %}
                                    {% if item %}
                                    {% set parts = item.split(' ') %}
                                    {% set material = parts[0] %}
                                    {% set proportion = parts[1].replace('%', '') %}
                                    <tr>
                                        <td>{{ material }}</td>
                                        <td>{{ proportion }}%</td>
                                        <td>{% if material_data.closest_countries and material_data.closest_countries.get(material) %}{{ material_data.closest_countries.get(material) }}{% else %}-{% endif %}</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="stats-container">
                             <button class="stats-button" id="openModal">
                                <svg class="stats-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 3v18h18"></path>
                                    <path d="M18.4 7.5l-7.8 9L6 12"></path>
                                </svg>
                                View Global Material Stats
                            </button>
                            <p class="stats-info">
                                Click to explore the distribution of interior materials across different countries.
                            </p>
                        </div>
                    </div>
                    {% endif %}

                     {% if segmentation_results %}
                     <div class="architectural-elements"> <!-- Contains Architectural Elements -->
                          <h2>Architectural Elements Analysis</h2>
                         <p class="section-description">Identifies distinct architectural styles and finds visually similar examples from different countries.</p>
                         <div class="elements-grid">
                             {% for element_type, data in segmentation_results.items() %}
                             <div class="element-card">
                                 <h3>{{ element_type | title }}</h3>
                                 <div class="element-content">
                                     <div class="element-image">
                                         <img src="{{ url_for('static', filename=data.cropped_image_path.replace('static/', '')) }}"
                                              alt="{{ element_type }}" class="segmented-image">
                                     </div>
                                     {% if data.get('similar_segments_info') %}
                                     <div class="similar-segments">
                                         <h4>Similar Segments Found</h4>
                                         <div class="similar-grid">
                                             {% for segment in data.similar_segments_info %}
                                             <div class="similar-item">
                                                 <div class="segment-image">
                                                     <img src="{{ url_for('main.serve_segmentations', filename=segment.path) }}"
                                                          alt="Similar {{ element_type }}">
                                                 </div>
                                                 <div class="segment-info">
                                                     <span class="similarity-score">Score: {{ "%.2f"|format(segment.score|float) }}</span>
                                                     <span class="country">{{ segment.country }}</span>
                                                 </div>
                                             </div>
                                             {% endfor %}
                                         </div>
                                     </div>
                                     {% else %}
                                      <p style="text-align: center; color: #888; font-size: 0.9em;">No similar segments found.</p>
                                     {% endif %}
                                 </div>
                             </div>
                             {% endfor %}
                         </div>
                     </div>
                     {% endif %}

                </div> <!-- End left-content -->

                <div class="chat-sidebar"> <!-- Contains Chat -->
                     <h2>Geo-location Assistant</h2>
                    <p class="section-description">The system reviews all model outputs and delivers a final, interpretable prediction. Confidence levels (Low/Medium/High) indicate the reliability of the analysis based on visual evidence strength, regional distinctiveness, and prediction consistency.</p>
                    <div id="chatWindow">
                        {% if initial_chat %}
                            {% for message in initial_chat %}
                                {% if message.role == "system" %}
                                {% else %}
                                <div class="assistant-message">
                                    <p class="assistant">
                                        <strong>Geo-location Assistant:</strong> {% set confidence = message.content.confidence_level | default('Medium') %}
                                        <span class="confidence-indicator confidence-{{ confidence|lower }}">
                                            {% if confidence == "High" %}游릭
                                            {% elif confidence == "Medium" %}游리
                                            {% else %}游댮{% endif %}
                                            {{ confidence }} Confidence
                                        </span>
                                        <br>{{ message.content.response | default('No response content.') }}
                                        <br><br><strong>Final Location Prediction:</strong>
                                        {% if message.content.predicted_country %}
                                            {{ message.content.predicted_country }}
                                        {% else %}
                                            Not found in analysis
                                        {% endif %}
                                        {% if message.content.uncertainty %}
                                            <div class="uncertainty-notes">Note: {{ message.content.uncertainty }}</div>
                                        {% endif %}
                                    </p>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Ask about the analysis...">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div> <!-- End chat-sidebar -->

            </div> <!-- End main-content-wrapper -->

            <div id="myModal" class="modal"> <!-- Modal -->
                <div class="modal-content">
                    <span class="close">&times;</span>
                     <h2>Global Interior Material Distribution</h2>
                    <p class="stats-description">
                        This visualization shows how different interior materials are distributed across countries,
                        helping understand regional preferences and design patterns.
                    </p>
                    <img src="/static/material_per_country.png" alt="Material per Country" style="width:100%; display: block; margin-top: 15px;">
                </div>
            </div>


            <div class="button-group"> <!-- Navigation Buttons -->
                 <a href="{{ url_for('main.upload_form') }}" class="button-link">New Analysis</a>
            </div>

        {% endif %} <!-- End main success block -->
    </div> <!-- End container -->

    <!-- JAVASCRIPT -->
    <script>
        // Chart.js Script (Modified title, added label)
        var continentData = {{ continent_percentages | default({}) | tojson | safe }}; // Added default
        var ctx = document.getElementById('continentChart').getContext('2d');
        var continentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(continentData),
                datasets: [{
                    label: 'Continent Confidence', // Added label
                    data: Object.values(continentData),
                    backgroundColor: [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(255, 99, 132, 0.6)' ],
                    borderColor: [ 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 99, 132, 1)' ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Keep false to allow height adjustment
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: { display: true, text: 'Continent Prediction Confidence', font: { size: 14, weight: 'bold' } },
                     tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { label += context.parsed.toFixed(1) + '%'; } return label; } } }
                },
                cutout: '50%',
                animation: { duration: 1000, easing: 'easeInOutBounce' }
            }
        });
    </script>
    <script>
        // Modal script
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("openModal");
        var span = document.getElementsByClassName("close")[0];
        if (btn) { btn.onclick = function() { if(modal) modal.style.display = "block"; } }
        if (span) { span.onclick = function() { if(modal) modal.style.display = "none"; } }
        window.onclick = function(event) { if (event.target == modal) { if(modal) modal.style.display = "none"; } }
    </script>
    <script>
        // Chat Script
        function initializeChat() {
            var chatWindow = document.getElementById('chatWindow');
            if (chatWindow) { chatWindow.scrollTop = chatWindow.scrollHeight; }
        }
        function sendMessage() {
            var chatInput = document.getElementById('chatInput');
            if (!chatInput) return;
            var message = chatInput.value;
            if (!message.trim()) return;
            chatInput.value = '';
            displayMessage("You", message);
            try {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: message, image_path: "{{ image_path | default('') | e }}" })
                })
                .then(response => { if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); })
                .then(data => { console.log("Received data:", data); if (data.reply) { displayMessage("LLaVA", data.reply); } else { console.warn("Received empty reply data."); displayMessage("System", "Received an empty response from the assistant."); } })
                .catch(error => { console.error('Error fetching or parsing response:', error); displayMessage("System", `Sorry, failed to get response: ${error.message}`); });
            } catch (error) { console.error('Error initiating fetch:', error); displayMessage("System", `Sorry, there was an error sending your message: ${error.message}`); }
        }
        function displayMessage(role, content) {
            var chatWindow = document.getElementById('chatWindow');
            if (!chatWindow) return; // Safety check

            var messageElem = document.createElement('div');
            messageElem.classList.add(role.toLowerCase() + '-message');

            let htmlContent = '';
            
            if (role === "LLaVA") {
                // 1. Extract Data
                // If content is object, use properties. If string, use directly.
                let responseText = (typeof content === 'object' && content.response) ? content.response : content;
                let confidence = (typeof content === 'object' && content.confidence_level) ? content.confidence_level : "Medium";
                let notes = (typeof content === 'object' && content.uncertainty) ? content.uncertainty : "";
                
                // 2. Determine Emoji
                let confidenceEmoji = confidence.toLowerCase() === "high" ? "游릭" :
                                    confidence.toLowerCase() === "medium" ? "游리" : "游댮";

                // 3. Build HTML (CLEANED UP)
                // We REMOVED the "Final Location Prediction" block here.
                // We keep the Assistant Header and Confidence Badge.
                htmlContent = `
                    <p class="assistant">
                        <strong>Geo-location Assistant:</strong> 
                        <span class="confidence-indicator confidence-${confidence.toLowerCase()}">
                            ${confidenceEmoji} ${confidence} Confidence
                        </span>
                        <br>
                        ${responseText}
                        ${notes ? `<div class="uncertainty-notes">Note: ${notes}</div>` : ''}
                    </p>`;
                    
            } else if (role === "System") {
                htmlContent = `<p class="system"><strong>${role}:</strong> ${content}</p>`;
            } else { // User
                htmlContent = `<p class="user"><strong>${role}:</strong> ${content}</p>`;
            }

            messageElem.innerHTML = htmlContent;
            chatWindow.appendChild(messageElem);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }
        var chatInputElem = document.getElementById('chatInput');
        if (chatInputElem) { chatInputElem.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); sendMessage(); } }); }
        document.addEventListener('DOMContentLoaded', function() { {% if not error %} initializeChat(); {% endif %} });
    </script>
</body>
</html>

