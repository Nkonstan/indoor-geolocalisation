
version: '3.8'
services:
  mongodb_migration:
    image: geo_datamigration
    container_name: vanguard-certh-mcag-migration
    volumes:
      - ./migrate_to_mongodb.py:/app/migrate_to_mongodb.py
      - ./:/app/data
    working_dir: /app
    environment:
      - MONGODB_URI=mongodb://mongodb:27017/
      - MONGODB_DATABASE=geolocation_db
      - SEGMENTATION_DB_DHN=/app/data/segmentation_features_dhn.csv
#      - DB_BINARY_PATH=/app/data/save_binarycodes_paths_labels_new/airbnb_14countries_trainedinwholedata_database_binary.npy
#      - DB_LABELS_PATH=/app/data/save_binarycodes_paths_labels_new/airbnb_14countries_trainedinwholedatabase_128bits_0.6296_database_labelspaths.ob
      - DB_BINARY_PATH=/app/data/save_binarycodes_paths_labels_new/airbnb_15countries_trainedinwholedata_database_binary.npy
      - DB_LABELS_PATH=/app/data/save_binarycodes_paths_labels_new/airbnb_15countries_trainedinwholedatabase_128bits_0.6296_database_labelspaths.ob
    depends_on:
      mongodb:
        condition: service_healthy
    restart: on-failure


  llava_app:
#    build:
#      context: .
#      dockerfile: Dockerfile
    image: llava_app  # Use the pre-built image
    container_name: mca-g-llava-app
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - CUDA_VISIBLE_DEVICES=0
      - DEBIAN_FRONTEND=noninteractive
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - MONGODB_URI=mongodb://mongodb:27017/
      - MONGODB_DATABASE=geolocation_db
      - TRANSFORMERS_OFFLINE=1
      - CLIP_MODEL_DIR=/app/clip-vit-large-patch14-336
    volumes:
      - ./llava-v1.6-mistral-7b:/app/llava-v1.6-mistral-7b
      - ./deit-base-distilled-patch16-384:/app/deit-base-distilled-patch16-384
      - ./clip-vit-large-patch14-336:/app/clip-vit-large-patch14-336
      - ./app:/app/app
      - ./requirements.txt:/app/requirements.txt
      - ./run.py:/app/run.py
      - ./material_per_country.png:/app/static/material_per_country.png
      - ./static:/app/static
      - ./segmentations:/app/segmentations
    working_dir: /app
    ports:
      - "5006:5000"
#    expose:
#      - 5000  # Keep this as it's the main API endpoint
    command: ["python3", "-u", "./run.py"]
    depends_on:
      mongodb_migration:
        condition: service_completed_successfully
      materobot:
        condition: service_started
    networks:
      - default
      - vanguard-network

  materobot:
    build:
      context: ./MATERobot
      dockerfile: Dockerfile.materobot
    container_name: mca-g-materobot
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - CUDA_VISIBLE_DEVICES=0
      - DEBIAN_FRONTEND=noninteractive
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./MATERobot:/app/MATERobot
      - ./static:/app/static
      - ./average_material_scores_per_country.csv:/app/average_material_scores_per_country.csv

    working_dir: /app/MATERobot
    # Remove external port mapping
    command: ["conda", "run", "-n", "materobot_env", "--no-capture-output", "python3", "-u", "materobot_app.py"]

  langsam:
    build:
      context: .
      dockerfile: LangSAM/Dockerfile.langsam
    container_name: mca-g-langsam
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
      - CUDA_VISIBLE_DEVICES=0
    volumes:
      - ./static:/app/static
      - ./sam-checkpoints:/root/.cache/torch/hub/checkpoints
      - ./grounding-dino-base:/app/grounding-dino-base
      - ./segmentations:/app/segmentations
      - ./LangSAM/app.py:/app/app.py
      - ./LangSAM/Dockerfile.langsam:/app/Dockerfile.langsam
      - ./LangSAM/requirements.txt:/app/requirements.txt
    # Remove external port mapping
    depends_on:
      - llava_app

  mongodb:
    image: mongo:latest
    container_name: mca-g-mongodb
    restart: always
    # Remove external port mapping
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    environment:
      - MONGO_INITDB_DATABASE=geolocation_db
    command: ["mongod", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  vanguard-network:
    name: vanguard-network
    external: true
  default:
    name: mca-g-lava-network
    driver: bridge
